<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Grocery List Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
        /*
         * IMPORTANT: The @apply directive is a Tailwind CSS feature that requires a build process (e.g., PostCSS).
         * For direct use in a <style> tag in a plain HTML file, we must manually expand
         * Tailwind's utility classes into standard CSS properties.
         * The styles below have been manually "compiled" from the previous @apply definitions.
         */

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            background-color: #ffffff; /* Equivalent of bg-white */
            border-radius: 1rem;       /* Equivalent of rounded-2xl */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1); /* Equivalent of shadow-xl */
        }
        .card {
            background-color: #ffffff;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding: 1.5rem;
        }
        .btn-primary {
            background-color: #2563eb; /* Equivalent of bg-blue-600 */
            color: #ffffff;            /* Equivalent of text-white */
            font-weight: 600;           /* Equivalent of font-semibold */
            padding: 0.5rem 1rem;       /* Equivalent of py-2 px-4 */
            border-radius: 0.5rem;      /* Equivalent of rounded-lg */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* Equivalent of shadow-md */
            transition-property: background-color; /* Equivalent of transition-colors */
            transition-duration: 200ms;            /* Equivalent of duration-200 */
        }
        .btn-primary:hover {
            background-color: #1d4ed8; /* Equivalent of hover:bg-blue-700 */
        }
        .btn-secondary {
            background-color: #e5e7eb; /* Equivalent of bg-gray-200 */
            color: #1f2937;            /* Equivalent of text-gray-800 */
            font-weight: 600;           /* Equivalent of font-semibold */
            padding: 0.5rem 1rem;       /* Equivalent of py-2 px-4 */
            border-radius: 0.5rem;      /* Equivalent of rounded-lg */
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* Equivalent of shadow-sm */
            transition-property: background-color; /* Equivalent of transition-colors */
            transition-duration: 200ms;            /* Equivalent of duration-200 */
        }
        .btn-secondary:hover {
            background-color: #d1d5db; /* Equivalent of hover:bg-gray-300 */
        }
        input[type="text"], select, textarea {
            width: 100%;
            padding: 0.75rem;          /* Equivalent of p-3 */
            border-width: 1px;         /* Equivalent of border */
            border-color: #d1d5db;     /* Equivalent of border-gray-300 */
            border-radius: 0.5rem;     /* Equivalent of rounded-lg */
        }
        input[type="text"]:focus, select:focus, textarea:focus {
            outline: 2px solid transparent; /* default outline reset */
            outline-offset: 2px;            /* default outline offset */
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5); /* focus:ring-blue-500 */
            border-color: #3b82f6;          /* focus:border-blue-500 */
        }
        .checkbox-label {
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        .checkbox-input {
            appearance: none; /* Hide default checkbox */
            -webkit-appearance: none;
            -moz-appearance: none;
            height: 1.25rem; /* Equivalent of h-5 */
            width: 1.25rem;  /* Equivalent of w-5 */
            background-color: #ffffff;
            border-width: 1px;
            border-color: #d1d5db;
            border-radius: 0.25rem; /* Equivalent of rounded */
            margin-right: 0.5rem; /* Equivalent of mr-2 */
            cursor: pointer;
            position: relative;
        }
        .checkbox-input:checked {
            background-color: #2563eb; /* Equivalent of text-blue-600 */
            border-color: #2563eb;
        }
        .checkbox-input:checked::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0.5rem; /* Checkmark width */
            height: 0.75rem; /* Checkmark height */
            border: solid #ffffff;
            border-width: 0 2px 2px 0;
            transform: translate(-50%, -65%) rotate(45deg);
        }
        .meal-card-image {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 0.5rem;
            margin-bottom: 0.75rem;
        }

        /* Custom styles for tabs - Manually Expanded */
        .tab-nav {
            display: flex;
            justify-content: center;
            margin-bottom: -1px; /* Equivalent of -mb-px to overlap with content border */
            background-color: #ffffff; /* Equivalent of bg-white */
            border-top-left-radius: 0.75rem;  /* Equivalent of rounded-t-xl */
            border-top-right-radius: 0.75rem; /* Equivalent of rounded-t-xl */
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* Equivalent of shadow-sm */
        }
        .tab-nav ul {
            display: flex;
            justify-content: center;
            width: 100%;
            list-style: none; /* Remove default list style */
            padding: 0;      /* Remove default padding */
            margin: 0;       /* Remove default margin */
        }
        .tab-button {
            padding: 1rem 2rem;       /* Equivalent of px-8 py-4 */
            font-size: 1.25rem;       /* Equivalent of text-xl */
            font-weight: 500;         /* Equivalent of font-medium */
            color: #4b5563;           /* Equivalent of text-gray-600 */
            border-bottom-width: 4px; /* Equivalent of border-b-4 */
            border-color: transparent;/* Equivalent of border-transparent */
            transition-property: all; /* Equivalent of transition-all */
            transition-duration: 200ms; /* Equivalent of duration-200 */
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); /* Equivalent of ease-in-out */
            cursor: pointer;
            background-color: transparent; /* Ensure no default button background */
            border-top-left-radius: 0.5rem; /* Added for subtle rounding */
            border-top-right-radius: 0.5rem; /* Added for subtle rounding */
            border-left: none; /* Remove default button borders */
            border-right: none;
            border-top: none;
            outline: none; /* Remove outline on focus if desired */
        }
        .tab-button:hover {
            color: #1d4ed8;       /* Equivalent of hover:text-blue-700 */
            border-color: #60a5fa; /* Equivalent of hover:border-blue-400 */
        }
        .tab-button.active {
            color: #1e40af;       /* Equivalent of text-blue-800 */
            border-color: #2563eb; /* Equivalent of border-blue-600 */
            font-weight: 700;     /* Equivalent of font-bold */
            background-color: #eff6ff; /* Equivalent of bg-blue-50 */
        }
        .tab-content {
            display: none; /* Hidden by default */
            background-color: #ffffff; /* Equivalent of bg-white */
            padding: 1.5rem;           /* Equivalent of p-6 */
            border-bottom-left-radius: 0.75rem;  /* Equivalent of rounded-b-xl */
            border-bottom-right-radius: 0.75rem; /* Equivalent of rounded-b-xl */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* Equivalent of shadow-md */
        }
        .tab-content.active {
            display: block; /* Show active tab content */
        }

        /* Adjustments for the main container to match rounded tabs */
        /* These are already applied directly to .container above, keeping this comment for context. */
        /* .container {
             @apply bg-white rounded-2xl shadow-xl p-8 my-8;
        } */

        /* Ensure the container's inner padding doesn't push tabs */
        .container > h1 {
            padding-top: 0; /* Adjust if needed, usually handled by margin-top */
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4">
    <div class="container bg-white rounded-2xl shadow-xl p-8 my-8">
        <h1 class="text-4xl font-extrabold text-center text-gray-900 mb-8 tracking-tight">
            Smart Grocery List Generator
        </h1>

        <nav class="tab-nav">
            <ul class="flex justify-center w-full"> <li><button class="tab-button active" data-tab="home">Home</button></li>
                <li><button class="tab-button" data-tab="meal-plan">Meal Plan & Pantry</button></li> <li><button class="tab-button" data-tab="grocery-list">Grocery List</button></li>
            </ul>
        </nav>

        <div id="home-content" class="tab-content active">
            <h2 class="text-3xl font-bold text-center text-gray-800 mb-6">Welcome to Your Smart Grocery Helper!</h2>
            <p class="text-lg text-gray-600 text-center max-w-2xl mx-auto">
                Plan your meals, manage your pantry, and generate efficient grocery lists, all in one place.
                Reduce food waste and save time on your shopping trips.
            </p>
            <div class="mt-8 flex justify-center gap-4">
                <button class="btn-primary" onclick="showTab('meal-plan')">Start Planning Meals</button>
                <button class="btn-secondary" onclick="showTab('grocery-list')">View Your Grocery List</button>
            </div>
        </div>

        <div id="meal-plan-content" class="tab-content"> <section class="p-6 bg-blue-50 rounded-xl shadow-inner">
                <h2 class="text-2xl font-bold text-blue-800 mb-6">Your Meal Plan & Pantry</h2>

                <div class="mb-6">
                    <label for="mealInput" class="block text-lg font-medium text-gray-700 mb-2">Search/Add Meals:</label>
                    <div class="relative">
                        <input type="text" id="mealInput" placeholder="e.g., Chicken Alfredo, Lentil Soup"
                               class="w-full p-3 pr-10 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <button id="addMealBtn" class="absolute inset-y-0 right-0 flex items-center px-4 text-blue-600 hover:text-blue-800">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                        </button>
                        <div id="mealSuggestions" class="absolute z-10 w-full bg-white border border-gray-200 rounded-lg shadow-lg mt-1 max-h-60 overflow-y-auto hidden"></div>
                    </div>
                    <div id="selectedMealsContainer" class="mt-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        </div>
                </div>

                <div class="mb-6">
                    <label class="block text-lg font-medium text-gray-700 mb-2">Dietary Preferences:</label>
                    <div id="dietaryPreferences" class="flex flex-wrap gap-4">
                        <label class="checkbox-label">
                            <input type="checkbox" name="diet" value="vegetarian" class="checkbox-input"> Vegetarian
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="diet" value="vegan" class="checkbox-input"> Vegan
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="diet" value="gluten-free" class="checkbox-input"> Gluten-Free
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="diet" value="dairy-free" class="checkbox-input"> Dairy-Free
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="diet" value="nut-free" class="checkbox-input"> Nut-Free
                        </label>
                    </div>
                </div>

                <div class="mb-6">
                    <label for="pantryInput" class="block text-lg font-medium text-gray-700 mb-2">What's in your Pantry?</label>
                    <div class="flex">
                        <input type="text" id="pantryInput" placeholder="e.g., eggs, milk, pasta"
                               class="flex-grow p-3 border border-gray-300 rounded-l-lg focus:ring-blue-500 focus:border-blue-500">
                        <button id="addPantryItemBtn" class="btn-primary rounded-l-none">Add</button>
                    </div>
                    <div id="pantryList" class="mt-3 flex flex-wrap gap-2">
                        </div>
                </div>

                <div class="text-center">
                    <button id="generateListBtn" class="btn-primary w-full md:w-auto px-12 py-3 text-xl">Generate Grocery List</button>
                </div>
            </section>
        </div>

        <div id="grocery-list-content" class="tab-content"> <section id="groceryListSection">
                <h2 class="text-3xl font-bold text-gray-900 text-center mb-8">Your Smart Grocery List</h2>
                <div id="groceryList" class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    </div>
                <div id="wasteOptimizationSuggestions" class="mt-10 p-6 bg-yellow-50 rounded-xl shadow-inner hidden">
                    <h3 class="text-2xl font-bold text-yellow-800 mb-4">Waste Optimization Suggestions:</h3>
                    <ul id="optimizationList" class="list-disc list-inside text-gray-700">
                        </ul>
                </div>
            </section>
        </div>

        <div id="messageBox" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
            <div class="bg-white rounded-xl p-8 max-w-sm w-full text-center shadow-lg">
                <h3 id="messageBoxTitle" class="text-xl font-bold mb-4 text-gray-900"></h3>
                <p id="messageBoxContent" class="text-gray-700 mb-6"></p>
                <button id="messageBoxCloseBtn" class="btn-primary">OK</button>
            </div>
        </div>

    </div>

    <script>
        // Your existing JavaScript code...
        // (Copy the entire script block from the previous response here)

        // Mock data for recipes - In a real app, this would come from an API
        const mockRecipes = [
            {
                id: 'chicken-alfredo',
                name: 'Chicken Alfredo',
                image: 'https://placehold.co/400x250/A7F3D0/10B981?text=Chicken+Alfredo', // Tailwind green placeholder
                servings: 4,
                dietary: [],
                ingredients: [
                    { item: 'Fettuccine pasta', quantity: 1, unit: 'lb', category: 'Pantry' },
                    { item: 'Chicken breasts', quantity: 2, unit: 'large', category: 'Proteins' },
                    { item: 'Heavy cream', quantity: 2, unit: 'cups', category: 'Dairy' },
                    { item: 'Parmesan cheese', quantity: 1, unit: 'cup', category: 'Dairy' },
                    { item: 'Garlic', quantity: 3, unit: 'cloves', category: 'Produce' },
                    { item: 'Butter', quantity: 0.5, unit: 'stick', category: 'Dairy' },
                    { item: 'Salt', quantity: 1, unit: 'tsp', category: 'Pantry' },
                    { item: 'Black pepper', quantity: 0.5, unit: 'tsp', category: 'Pantry' }
                ]
            },
            {
                id: 'lentil-soup',
                name: 'Hearty Lentil Soup',
                image: 'https://placehold.co/400x250/FDE68A/D97706?text=Lentil+Soup', // Tailwind yellow placeholder
                servings: 6,
                dietary: ['vegetarian', 'vegan', 'gluten-free'],
                ingredients: [
                    { item: 'Brown lentils', quantity: 1.5, unit: 'cups', category: 'Pantry' },
                    { item: 'Vegetable broth', quantity: 6, unit: 'cups', category: 'Pantry' },
                    { item: 'Carrots', quantity: 2, unit: 'medium', category: 'Produce' },
                    { item: 'Celery stalks', quantity: 2, unit: 'medium', category: 'Produce' },
                    { item: 'Onion', quantity: 1, unit: 'large', category: 'Produce' },
                    { item: 'Canned diced tomatoes', quantity: 1, unit: '14.5oz can', category: 'Pantry' },
                    { item: 'Garlic', quantity: 2, unit: 'cloves', category: 'Produce' },
                    { item: 'Olive oil', quantity: 2, unit: 'tbsp', category: 'Pantry' },
                    { item: 'Cumin', quantity: 1, unit: 'tsp', category: 'Pantry' },
                    { item: 'Thyme', quantity: 0.5, unit: 'tsp', category: 'Pantry' },
                    { item: 'Salt', quantity: 1, unit: 'tsp', category: 'Pantry' },
                    { item: 'Black pepper', quantity: 0.5, unit: 'tsp', category: 'Pantry' }
                ]
            },
            {
                id: 'beef-tacos',
                name: 'Beef Tacos',
                image: 'https://placehold.co/400x250/FEF2F2/EF4444?text=Beef+Tacos', // Tailwind red placeholder
                servings: 4,
                dietary: [],
                ingredients: [
                    { item: 'Ground beef', quantity: 1, unit: 'lb', category: 'Proteins' },
                    { item: 'Taco shells', quantity: 12, unit: '', category: 'Pantry' },
                    { item: 'Taco seasoning', quantity: 1, unit: 'pack', category: 'Pantry' },
                    { item: 'Lettuce', quantity: 1, unit: 'head', category: 'Produce' },
                    { item: 'Tomatoes', quantity: 2, unit: 'medium', category: 'Produce' },
                    { item: 'Shredded cheddar cheese', quantity: 1, unit: 'cup', category: 'Dairy' },
                    { item: 'Sour cream', quantity: 0.5, unit: 'cup', category: 'Dairy' }
                ]
            },
            {
                id: 'mediterranean-quinoa-salad',
                name: 'Mediterranean Quinoa Salad',
                image: 'https://placehold.co/400x250/D1FAE5/065F46?text=Quinoa+Salad', // Tailwind emerald placeholder
                servings: 4,
                dietary: ['vegetarian', 'vegan', 'gluten-free'],
                ingredients: [
                    { item: 'Quinoa', quantity: 1, unit: 'cup', category: 'Pantry' },
                    { item: 'Cucumber', quantity: 1, unit: 'medium', category: 'Produce' },
                    { item: 'Cherry tomatoes', quantity: 1, unit: 'pint', category: 'Produce' },
                    { item: 'Red onion', quantity: 0.5, unit: 'small', category: 'Produce' },
                    { item: 'Kalamata olives', quantity: 0.5, unit: 'cup', category: 'Pantry' },
                    { item: 'Fresh parsley', quantity: 0.25, unit: 'cup', category: 'Produce' },
                    { item: 'Lemon', quantity: 1, unit: 'medium', category: 'Produce' },
                    { item: 'Olive oil', quantity: 0.25, unit: 'cup', category: 'Pantry' },
                    { item: 'Feta cheese', quantity: 0.5, unit: 'cup', category: 'Dairy' }
                ]
            }
        ];

        // Global state variables
        const selectedMeals = new Map(); // Stores { recipeId: { recipe: {}, servings: N } }
        const pantryItems = new Set(); // Stores unique string items in pantry

        // DOM Elements
        const mealInput = document.getElementById('mealInput');
        const addMealBtn = document.getElementById('addMealBtn');
        const mealSuggestionsDiv = document.getElementById('mealSuggestions');
        const selectedMealsContainer = document.getElementById('selectedMealsContainer');
        const dietaryCheckboxes = document.querySelectorAll('#dietaryPreferences input[type="checkbox"]');
        const pantryInput = document.getElementById('pantryInput');
        const addPantryItemBtn = document.getElementById('addPantryItemBtn');
        const pantryListDiv = document.getElementById('pantryList');
        const generateListBtn = document.getElementById('generateListBtn');
        const groceryListSection = document.getElementById('groceryListSection');
        const groceryListDiv = document.getElementById('groceryList');
        const wasteOptimizationSuggestions = document.getElementById('wasteOptimizationSuggestions');
        const optimizationList = document.getElementById('optimizationList');

        const messageBox = document.getElementById('messageBox');
        const messageBoxTitle = document.getElementById('messageBoxTitle');
        const messageBoxContent = document.getElementById('messageBoxContent');
        const messageBoxCloseBtn = document.getElementById('messageBoxCloseBtn');

        // --- Utility Functions ---

        /**
         * Displays a custom message box.
         * @param {string} title - The title of the message.
         * @param {string} content - The content of the message.
         */
        function showMessageBox(title, content) {
            messageBoxTitle.textContent = title;
            messageBoxContent.textContent = content;
            messageBox.classList.remove('hidden');
        }

        /**
         * Closes the custom message box.
         */
        function closeMessageBox() {
            messageBox.classList.add('hidden');
        }

        /**
         * Normalizes an ingredient name for better matching.
         * Converts to lowercase and removes plural 's' or common suffixes.
         * @param {string} name
         * @returns {string}
         */
        function normalizeIngredientName(name) {
            return name.toLowerCase()
                       .replace(/s$/, '') // Remove plural 's'
                       .replace(/(\s*(diced|chopped|sliced|fresh|canned|dried|ground))\s*/g, ''); // Remove descriptors
        }

        /**
         * Capitalizes the first letter of each word in a string.
         * @param {string} str
         * @returns {string}
         */
        function capitalizeWords(str) {
            return str.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
        }


        // --- Meal Selection Logic ---

        /**
         * Renders meal suggestions based on input and filters.
         */
        function renderMealSuggestions() {
            const query = mealInput.value.toLowerCase();
            const selectedDiets = Array.from(dietaryCheckboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value);

            // Filter recipes by query and dietary preferences
            const filteredRecipes = mockRecipes.filter(recipe => {
                const matchesName = recipe.name.toLowerCase().includes(query);
                const matchesDiet = selectedDiets.every(diet => recipe.dietary.includes(diet));
                return matchesName && matchesDiet;
            });

            mealSuggestionsDiv.innerHTML = '';
            if (query.length > 0 && filteredRecipes.length > 0) {
                filteredRecipes.forEach(recipe => {
                    // Don't show suggestions for already added meals
                    if (!selectedMeals.has(recipe.id)) {
                        const suggestionItem = document.createElement('div');
                        suggestionItem.className = 'p-3 hover:bg-blue-50 cursor-pointer rounded-md flex items-center';
                        suggestionItem.innerHTML = `
                            <img src="${recipe.image}" alt="${recipe.name}" class="w-10 h-10 rounded-full mr-3 object-cover">
                            <span class="font-medium text-gray-800">${recipe.name}</span>
                        `;
                        suggestionItem.onclick = () => {
                            addMealToSelection(recipe);
                            mealInput.value = '';
                            mealSuggestionsDiv.classList.add('hidden');
                        };
                        mealSuggestionsDiv.appendChild(suggestionItem);
                    }
                });
                mealSuggestionsDiv.classList.remove('hidden');
            } else {
                mealSuggestionsDiv.classList.add('hidden');
            }
        }

        /**
         * Adds a meal to the selected meals section.
         * @param {Object} recipe - The recipe object to add.
         */
        function addMealToSelection(recipe) {
            if (selectedMeals.has(recipe.id)) {
                showMessageBox('Already Added', `${recipe.name} is already in your meal plan.`);
                return;
            }

            const servings = recipe.servings || 4; // Default to 4 servings
            selectedMeals.set(recipe.id, { recipe, servings });
            renderSelectedMeals();
        }

        /**
         * Renders all currently selected meals in the UI.
         */
        function renderSelectedMeals() {
            selectedMealsContainer.innerHTML = '';
            if (selectedMeals.size === 0) {
                selectedMealsContainer.innerHTML = '<p class="text-gray-500 text-center col-span-full">No meals added yet.</p>';
                return;
            }

            selectedMeals.forEach(({ recipe, servings }) => {
                const mealCard = document.createElement('div');
                mealCard.className = 'card flex flex-col items-center p-4 relative';
                mealCard.innerHTML = `
                    <button class="absolute top-2 right-2 text-gray-400 hover:text-red-600" data-id="${recipe.id}">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                    <img src="${recipe.image}" alt="${recipe.name}" class="meal-card-image">
                    <h3 class="text-xl font-semibold text-gray-800 mb-2 text-center">${recipe.name}</h3>
                    <div class="flex items-center mt-2">
                        <label for="servings-${recipe.id}" class="text-gray-700 mr-2">Servings:</label>
                        <input type="number" id="servings-${recipe.id}" value="${servings}" min="1"
                               class="w-20 p-2 border border-gray-300 rounded-lg text-center text-sm"
                               data-id="${recipe.id}">
                    </div>
                `;
                selectedMealsContainer.appendChild(mealCard);

                // Add event listener for removing meal
                mealCard.querySelector('button[data-id]').addEventListener('click', (e) => {
                    const idToRemove = e.currentTarget.dataset.id;
                    selectedMeals.delete(idToRemove);
                    renderSelectedMeals();
                });

                // Add event listener for servings change
                mealCard.querySelector(`input[data-id="${recipe.id}"]`).addEventListener('change', (e) => {
                    const id = e.target.dataset.id;
                    const newServings = parseInt(e.target.value, 10);
                    if (selectedMeals.has(id) && !isNaN(newServings) && newServings > 0) {
                        selectedMeals.get(id).servings = newServings;
                    } else {
                        e.target.value = selectedMeals.get(id).servings; // Revert to old value if invalid
                    }
                });
            });
        }

        // --- Pantry Logic ---

        /**
         * Adds an item to the pantry list.
         */
        function addPantryItem() {
            const itemText = pantryInput.value.trim();
            if (itemText) {
                const normalizedItem = normalizeIngredientName(itemText);
                if (!pantryItems.has(normalizedItem)) {
                    pantryItems.add(normalizedItem);
                    renderPantryItems();
                } else {
                    showMessageBox('Already in Pantry', `${capitalizeWords(itemText)} is already in your pantry.`);
                }
                pantryInput.value = '';
            }
        }

        /**
         * Renders all items in the pantry list.
         */
        function renderPantryItems() {
            pantryListDiv.innerHTML = '';
            if (pantryItems.size === 0) {
                pantryListDiv.innerHTML = '<p class="text-gray-500">Your pantry is empty. Add some ingredients!</p>';
                return;
            }
            pantryItems.forEach(item => {
                const itemSpan = document.createElement('span');
                itemSpan.className = 'inline-flex items-center bg-blue-100 text-blue-800 text-sm font-medium px-3 py-1 rounded-full shadow-sm';
                itemSpan.innerHTML = `
                    ${capitalizeWords(item)}
                    <button class="ml-2 text-blue-600 hover:text-blue-900" data-item="${item}">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                `;
                pantryListDiv.appendChild(itemSpan);

                itemSpan.querySelector('button[data-item]').addEventListener('click', (e) => {
                    const itemToRemove = e.currentTarget.dataset.item;
                    pantryItems.delete(itemToRemove);
                    renderPantryItems();
                });
            });
        }

        // --- Grocery List Generation Logic ---

        /**
         * Generates and displays the grocery list.
         */
        function generateGroceryList() {
            if (selectedMeals.size === 0) {
                showMessageBox('No Meals Selected', 'Please select at least one meal to generate a grocery list.');
                return;
            }

            const combinedIngredients = new Map(); // { normalizedItem: { item: originalName, quantity: N, unit: unit, category: category } }
            const missingIngredients = new Set(); // Stores ingredients not in pantry for selected meals

            selectedMeals.forEach(({ recipe, servings: desiredServings }) => {
                const scalingFactor = desiredServings / recipe.servings;

                recipe.ingredients.forEach(ingredient => {
                    const normalizedItem = normalizeIngredientName(ingredient.item);
                    const scaledQuantity = ingredient.quantity * scalingFactor;

                    // If not in pantry, it's a missing ingredient
                    if (!pantryItems.has(normalizedItem)) {
                        missingIngredients.add(normalizedItem);
                    }

                    if (combinedIngredients.has(normalizedItem)) {
                        const existing = combinedIngredients.get(normalizedItem);
                        existing.quantity += scaledQuantity; // Sum quantities for same item
                    } else {
                        combinedIngredients.set(normalizedItem, {
                            item: ingredient.item,
                            quantity: scaledQuantity,
                            unit: ingredient.unit,
                            category: ingredient.category || 'Miscellaneous' // Default category
                        });
                    }
                });
            });

            // Group ingredients by category
            const categorizedList = {};
            combinedIngredients.forEach(ing => {
                // Only add to grocery list if not in pantry
                if (!pantryItems.has(normalizeIngredientName(ing.item))) {
                    const category = ing.category;
                    if (!categorizedList[category]) {
                        categorizedList[category] = [];
                    }
                    categorizedList[category].push(ing);
                }
            });

            // Sort categories and ingredients for consistent display
            const sortedCategories = Object.keys(categorizedList).sort();
            groceryListDiv.innerHTML = ''; // Clear previous list

            if (sortedCategories.length === 0) {
                groceryListDiv.innerHTML = '<p class="text-gray-500 text-center col-span-full">All ingredients for your selected meals are already in your pantry!</p>';
            } else {
                sortedCategories.forEach(category => {
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'card p-6';
                    categoryDiv.innerHTML = `<h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">${category}</h3>`;
                    const ul = document.createElement('ul');
                    ul.className = 'list-disc pl-5 text-gray-700';

                    categorizedList[category].sort((a, b) => a.item.localeCompare(b.item)).forEach(ing => {
                        const li = document.createElement('li');
                        // Format quantity (e.g., 2.5 becomes "2.5", 2.0 becomes "2")
                        const displayQuantity = (ing.quantity % 1 === 0) ? ing.quantity : ing.quantity.toFixed(1);
                        li.textContent = `${displayQuantity} ${ing.unit ? ing.unit + ' ' : ''}${capitalizeWords(ing.item)}`;
                        ul.appendChild(li);
                    });
                    categoryDiv.appendChild(ul);
                    groceryListDiv.appendChild(categoryDiv);
                });
            }

            renderWasteOptimizationSuggestions();
            // This section is now handled by the tab logic, no direct show/hide here.
            // groceryListSection.classList.remove('hidden'); // REMOVE THIS LINE
            showTab('grocery-list'); // Automatically switch to grocery list tab
        }

        /**
         * Renders suggestions for waste optimization.
         * (Simplified for this mock example)
         */
        function renderWasteOptimizationSuggestions() {
            optimizationList.innerHTML = '';
            let hasSuggestions = false;

            // Suggest using pantry items that might be less common or have specific uses
            const suggestedPantryUses = [
                'Parmesan cheese', 'Canned diced tomatoes', 'Olive oil', 'Garlic'
            ];

            pantryItems.forEach(item => {
                if (suggestedPantryUses.includes(capitalizeWords(item))) {
                    const li = document.createElement('li');
                    li.textContent = `Consider using your existing ${capitalizeWords(item)} in other recipes this week.`;
                    optimizationList.appendChild(li);
                    hasSuggestions = true;
                }
            });

            // If selected meals used some ingredients but left others in pantry
            // This is a more complex logic, for simplicity we'll just check for unused pantry items
            if (pantryItems.size > 0 && selectedMeals.size > 0) {
                   const allRecipeIngredients = new Set();
                   selectedMeals.forEach(({ recipe }) => {
                       recipe.ingredients.forEach(ing => allRecipeIngredients.add(normalizeIngredientName(ing.item)));
                   });

                   pantryItems.forEach(pantryItem => {
                       if (!allRecipeIngredients.has(pantryItem)) {
                           const li = document.createElement('li');
                           li.textContent = `You have ${capitalizeWords(pantryItem)} in your pantry that wasn't used in your selected meals. Can you find another use for it?`;
                           optimizationList.appendChild(li);
                           hasSuggestions = true;
                       }
                   });
            }


            if (hasSuggestions) {
                wasteOptimizationSuggestions.classList.remove('hidden');
            } else {
                wasteOptimizationSuggestions.classList.add('hidden');
            }
        }

        // --- Tab Switching Logic ---
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');

        function showTab(tabId) {
            // Hide all tab contents
            tabContents.forEach(content => content.classList.remove('active'));
            // Deactivate all tab buttons
            tabButtons.forEach(button => button.classList.remove('active'));

            // Show the selected tab content
            document.getElementById(`${tabId}-content`).classList.add('active');
            // Activate the corresponding tab button
            document.querySelector(`.tab-button[data-tab="${tabId}"]`).classList.add('active');

            // Special handling for grocery list tab to ensure it's generated/updated
            if (tabId === 'grocery-list' && selectedMeals.size > 0) {
                // Ensure the list is current if the user navigates directly
                // (though generateGroceryList handles its own switching now)
                generateGroceryList();
            } else if (tabId === 'grocery-list') {
                 // If no meals are selected, clear the grocery list section content
                 groceryListDiv.innerHTML = '<p class="text-gray-500 text-center col-span-full">Select meals on the "Meal Plan & Pantry" tab to generate your grocery list.</p>'; // Updated text
                 wasteOptimizationSuggestions.classList.add('hidden');
            }
        }

        // --- Event Listeners ---

        // Meal input and suggestions
        mealInput.addEventListener('input', renderMealSuggestions);
        mealInput.addEventListener('focus', renderMealSuggestions); // Show suggestions on focus
        addMealBtn.addEventListener('click', () => {
            const mealName = mealInput.value.trim().toLowerCase();
            const recipe = mockRecipes.find(r => r.name.toLowerCase() === mealName);
            if (recipe) {
                addMealToSelection(recipe);
                mealInput.value = '';
                mealSuggestionsDiv.classList.add('hidden');
            } else if (mealName) {
                showMessageBox('Meal Not Found', `"${capitalizeWords(mealName)}" was not found in our recipe list.`);
            }
        });
        // Hide suggestions when clicking outside
        document.addEventListener('click', (event) => {
            if (!mealInput.contains(event.target) && !mealSuggestionsDiv.contains(event.target) && !addMealBtn.contains(event.target)) {
                mealSuggestionsDiv.classList.add('hidden');
            }
        });

        // Dietary preferences
        dietaryCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', renderMealSuggestions);
        });

        // Pantry input
        addPantryItemBtn.addEventListener('click', addPantryItem);
        pantryInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                addPantryItem();
            }
        });

        // Generate list button
        generateListBtn.addEventListener('click', generateGroceryList); // This will now also switch the tab

        // Message box close button
        messageBoxCloseBtn.addEventListener('click', closeMessageBox);

        // Tab button event listeners
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const tabId = button.dataset.tab;
                showTab(tabId);
            });
        });

        // --- Initial Render ---
        renderSelectedMeals(); // Initialize selected meals area
        renderPantryItems(); // Initialize pantry area
        showTab('home'); // Show the home tab by default when the page loads
    </script>
</body>
</html>